name: ðŸ” Test Signing Secrets

on:
  workflow_dispatch:

jobs:
  test-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ§ª Test Keystore Access (Repository Keystore)
        run: |
          echo "ðŸ” Testing keystore access with repository keystore..."

          # Verificar que el keystore existe en el repositorio
          echo "ðŸ“‹ Checking repository keystore:"

          if [ ! -f "android/keys/keystore.jks" ]; then
            echo "âŒ Repository keystore not found at android/keys/keystore.jks"
            echo "ðŸ“‚ Contents of android/keys/:"
            ls -la android/keys/ || echo "Directory not found"
            KEYSTORE_STATUS="âŒ Missing"
          else
            KEYSTORE_SIZE=$(du -h android/keys/keystore.jks | cut -f1)
            echo "âœ… Repository keystore found: android/keys/keystore.jks ($KEYSTORE_SIZE)"
            KEYSTORE_STATUS="âœ… Present"
          fi

          # Verificar secrets de passwords
          echo ""
          echo "ðŸ“‹ Checking password secrets:"

          if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
            echo "âŒ KEYSTORE_PASSWORD secret is empty or missing"
            SECRET_PASSWORD_STATUS="âŒ Missing"
          else
            echo "âœ… KEYSTORE_PASSWORD secret exists"
            SECRET_PASSWORD_STATUS="âœ… Present"
          fi

          if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
            echo "âŒ KEY_ALIAS secret is empty or missing"
            SECRET_ALIAS_STATUS="âŒ Missing"
          else
            echo "âœ… KEY_ALIAS secret exists: '${{ secrets.KEY_ALIAS }}'"
            SECRET_ALIAS_STATUS="âœ… Present"
          fi

          if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "âŒ KEY_PASSWORD secret is empty or missing"
            SECRET_KEY_PASSWORD_STATUS="âŒ Missing"
          else
            echo "âœ… KEY_PASSWORD secret exists"
            SECRET_KEY_PASSWORD_STATUS="âœ… Present"
          fi

          # Intentar crear el keystore
          echo ""
          echo "ðŸ”§ Testing keystore creation from base64..."

          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > test-keystore.keystore
            
            if [ -f "test-keystore.keystore" ]; then
              echo "âœ… Keystore file created successfully"
              KEYSTORE_SIZE=$(du -h test-keystore.keystore | cut -f1)
              echo "   Size: $KEYSTORE_SIZE"
              
              # Verificar que el keystore es vÃ¡lido
              if [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ] && [ -n "${{ secrets.KEY_ALIAS }}" ]; then
                echo ""
                echo "ðŸ”‘ Testing keystore validity..."
                if keytool -list -keystore test-keystore.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" -alias "${{ secrets.KEY_ALIAS }}" > /dev/null 2>&1; then
                  echo "âœ… Keystore is valid and accessible"
                  KEYSTORE_VALIDITY="âœ… Valid"
                  
                  # Obtener informaciÃ³n del certificado
                  echo "ðŸ“‹ Certificate info:"
                  keytool -list -keystore test-keystore.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" -alias "${{ secrets.KEY_ALIAS }}" -v | grep -E "(Alias name|Creation date|Valid)"
                else
                  echo "âŒ Keystore validation failed"
                  echo "   Either password or alias is incorrect"
                  KEYSTORE_VALIDITY="âŒ Invalid"
                fi
              else
                echo "âš ï¸ Cannot test keystore - missing password or alias"
                KEYSTORE_VALIDITY="âš ï¸ Untested"
              fi
            else
              echo "âŒ Failed to create keystore from base64"
              echo "   Base64 content might be corrupted"
              KEYSTORE_VALIDITY="âŒ Creation failed"
            fi
          else
            echo "âŒ Cannot test - KEYSTORE_BASE64 is empty"
            KEYSTORE_VALIDITY="âŒ No data"
          fi

          # Limpiar archivo temporal
          rm -f test-keystore.keystore

          # Resumen
          echo ""
          echo "ðŸ“Š SUMMARY"
          echo "=========="
          echo "KEYSTORE_BASE64: $SECRET_KEYSTORE_STATUS"
          echo "KEYSTORE_PASSWORD: $SECRET_PASSWORD_STATUS"
          echo "KEY_ALIAS: $SECRET_ALIAS_STATUS"
          echo "KEY_PASSWORD: $SECRET_KEY_PASSWORD_STATUS"
          echo "Keystore Validity: $KEYSTORE_VALIDITY"

          # Crear signing.properties de prueba
          echo ""
          echo "ðŸ“ Testing signing.properties creation..."
          cat > test-signing.properties << EOF
          storeFile=test-keystore.keystore
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

          echo "âœ… signing.properties created:"
          echo "   Store File: $(grep storeFile test-signing.properties | cut -d'=' -f2)"
          echo "   Key Alias: $(grep keyAlias test-signing.properties | cut -d'=' -f2)"

          rm -f test-signing.properties

          echo ""
          echo "ðŸŽ¯ RESULT: Secrets test completed"
